---
layout: post
title:  "Baseball Analysis"
date:   2016-05-28 22:28:01 -0500
categories: baseball
---

```{r include = FALSE}
###############################################################################
# Project: Baseball
# Author(s): Thomas Burr
# Date created: 2015 05 26
###############################################################################


################################################################################
# load in libraries and source files
################################################################################


# libraries:
librariesToLoad <- c( 'plyr','tidyr','knitr', 'ggplot2',
                     'scales','ggthemes','Lahman','dplyr')

suppressWarnings(suppressMessages(expr={
    sapply(librariesToLoad, function(package) {
        if (require(package, character.only=TRUE)){     
            print(paste(package, "loaded correctly", sep=" "))
        } else {
            print(paste("Installing", package, sep=" "))
            install.packages(package,repos="http://cran.rstudio.com/")
            
            if (require(package, character.only=TRUE)){
              print(paste(package, "loaded correctly", sep=" "))
            } else {
                stop(paste("Could not install", package, sep=" "))
            }
        }
    })
}))


```
### Overview

Going into the last day of the 1941 season, Ted Williams  was batting .39955 and offered the chance to sit out the final day of the season to ensure that he would finish the 13th ".400" season in Major League Baseball history. Instead, he played both games of a double-header against the Philadelphia Athletics, going 6 for 8 and finishing the season sitting at .406 over 456 at-bats. This made for a minor news story, (Williams even lost the MVP vote to Joe DiMaggio and his 56 game hitting streak) but it would likely have been a much bigger deal had anyone known that Williams just might have been the last player to ever accomplish the feat. 

Over the first 40 years of modern baseball, 8 different men managed to break the .400 barrier. In the 74 seasons since, the closest anyone has come over a full season of play was George Brett, who hit .390 in 1980. While a simple explanation for this would be that Ted Williams was simply one of the greatest hitters ***of all***  time,  a more complete explanation is that he was one of the greatest hitters ***relative*** to his time. Batting average is not a solitary statistic, but one composed of the skill of not only the batter, but also the pitcher and fielders against whom he his playing. 

Consider the following:


Baseball glove, 1911. Ty Cobb leads the league at .420

![](http://baseballhall.org/sites/default/files/styles/fullscreen_image_popup/public/externals/5431720de9843cd3dea7ccfdc78a601f.jpeg)

Baseball glove, 1941, Ted Williams leads the league at .406
![](http://baseballhall.org/sites/default/files/styles/fullscreen_image_popup/public/externals/a711549780dca6dccb18d1581f662715.jpeg)

Baseball glove, 2015. Dee Gordon leads the league at .333
![](http://ep.yimg.com/ay/nutosportsinc/wilson-a2000-series-outfield-glove-12-75in-wta20rb161799-2016-1.jpg)


### Data Summary

I use the Lahman R package to access the Lahman database, pulling player-year level batting statistics from "Batting." The Lahman package also automatically computes several key statistics for us such as batting average, on-base percentage, and slugging percentage that are missing from the main data set. I subset the data to NL and AL players beginning with the AL inaugeral season, 1901. 


```{r}
#Bring in available "advanced" batting stats
bstats <- tbl_df(battingStats())


#Filter to NL/AL Only, starting with AL inaugeral season in 1901
bstats <- bstats %>% filter(lgID == "NL" | lgID =="AL",
                            yearID >= 1901,
                            PA > 0)

```

The dataset is missing two key stats that we will need, number of singles and Isolated Power (slugging % - batting average) 

```{r}
#Add singles as a category
bstats <- bstats %>% mutate(X1B = H - X2B - X3B - HR)

#Create ISO
bstats$ISO = bstats$SlugPct - bstats$BA

```

For each year, we would like to know who the league leaders were in batting average (AVG), slugging percentage (SLG), and isolated power (ISO). For ease of computation, I also save each leader's numbers for all 3 categories. This, for example, will allow us to see how the ISO has changed over time for the typical batting average leader. 

```{r fig.width == 10}
ba_league_leaders <- bstats %>% filter(PA > 400 | AB > 500) %>% 
                                group_by(yearID) %>% 
                                slice(which.max(BA)) %>% 
                                ungroup() %>% 
                                select(ba_leader = playerID,
                                       yearID,
                                       ba_leader_ba = BA,
                                       ba_leader_slg = SlugPct,
                                       ba_leader_iso = ISO)

slg_league_leaders <- bstats %>% filter(PA > 400 | AB > 500) %>% 
                                 group_by(yearID) %>% 
                                 slice(which.max(SlugPct)) %>% 
                                 ungroup() %>% 
                                 select(slg_leader = playerID,
                                        yearID,
                                        slg_leader_slg = SlugPct,
                                        slg_leader_ba = BA,
                                        slg_leader_iso = ISO)

iso_league_leaders <- bstats %>% filter(PA > 400 | AB > 500) %>% 
                                 group_by(yearID) %>% 
                                 slice(which.max(ISO)) %>% 
                                 ungroup() %>% 
                                 select(iso_leader = playerID,
                                        yearID,
                                        iso_leader_slg = SlugPct,
                                        iso_leader_ba = BA,
                                        iso_leader_iso = ISO)

league_leaders <- merge(ba_league_leaders,slg_league_leaders,by = "yearID")
league_leaders <- merge(league_leaders,iso_league_leaders,by = "yearID")


bstats <- left_join(bstats,league_leaders, by = "yearID")

ggplot(iso_league_leaders,aes(x= yearID,y = iso_leader_iso,label = iso_leader)) + geom_text()
```


Include in stdev everyone with at least 200 at bats

```{r}
try (detach('package:plyr'))
yearly_bstats <- bstats %>% filter(PA > 400)
yearly_bstats <- yearly_bstats %>% group_by(yearID) %>% summarise(
                                              num_qualified = n(),
                                              ba_std = sd(BA),
                                              slg_std = sd(SlugPct),
                                              ba_avg = mean(BA),
                                              slg_avg = mean(SlugPct))

bstats <- left_join(bstats,yearly_bstats,by= 'yearID')
yearly_bstats <- merge(yearly_bstats,league_leaders,by="yearID")

```

One problem, however, is that these stats can only be calculated at the player level. Thus if we were to, for example, average all batting averages in a year, a player with 50 PA would weight equally as one with 500. We can get around this by creating a year-level total of the underlying stats (Hits, walks, 2B, HR etc.) and recalculating the percentages at a year level.


```{r}

ggplot(yearly_bstats,aes(x = yearID,y = ba_avg)) + geom_line() + theme_wsj() + scale_y_continuous(breaks = c(.240,.250,.260,.270,.280,.290,.300,.310),
                   labels = c('.240','.250','.260','.270',
                              '.280','.290','.300','.310'))

tidy_batting_percentages <- gather(yearly_bstats,statistic,average,ba_avg,slg_avg)


ggplot(tidy_batting_percentages,aes(x = yearID,y = average,color = statistic)) + geom_line() + theme_wsj() 


```


Batting Average vs league leader?

```{r}


ggplot(yearly_bstats,aes(x = yearID,y = ba_avg)) + geom_line() +stat_smooth(method = "lm") + theme_wsj() +ylim(.200,.450) +geom_point(data = yearly_bstats,aes(x=yearID,y=ba_leader_ba)) + theme_fivethirtyeight()

yearly_bstats$ba_max_spread <- yearly_bstats$ba_leader_ba - yearly_bstats$ba_avg

ggplot(yearly_bstats,aes(x = yearID,y = ba_max_spread, label = ba_leader)) + geom_point() +stat_smooth() + theme_wsj() +ylim(0,.200)

```

```{r}
ggplot(yearly_bstats,aes(x = yearID,y = slg_avg)) + geom_line() +stat_smooth(method = "lm") + theme_wsj() +ylim(.300,.800) +geom_point(data = yearly_bstats,aes(x=yearID,y=slg_leader_slg))

yearly_bstats$max_slg_spread<- yearly_bstats$slg_leader_slg- yearly_bstats$slg_avg

ggplot(yearly_bstats,aes(x = yearID,y = max_slg_spread)) + geom_point() +stat_smooth(method = "lm") + theme_fivethirtyeight() +ylim(0,.500)
```


```{r}

yearly_bstats <- yearly_bstats %>% mutate(std_away_ba = (ba_leader_ba - ba_avg)/ba_std,
                                          std_away_slg = (slg_leader_slg - slg_avg)/slg_std)

bstats <- bstats %>% filter(PA > 400) %>% mutate(std_away_ba = (BA - ba_avg)/ba_std,
                                          std_away_slg = (SlugPct - slg_avg)/slg_std)

ggplot(yearly_bstats,aes(x=yearID,y=std_away_ba,label = ba_leader)) + geom_text()
ggplot(yearly_bstats,aes(x=yearID,y=std_away_slg,label = slg_leader)) + geom_text()



```
